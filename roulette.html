<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette</title>
    <link href="style.css" rel="stylesheet">
</head>

<body class="dashboard">

<div class="navbar">
    <img src="icon.png" class="logo">
    <nav>Ripple Roulette</nav>
    <nav class="nav-links">
        <a href="dashboard.html">Back</a>
    </nav>
</div>

<h2 id="balanceDisplay" class="balance-top">Balance: ...</h2>

<div class="game-container">
    <h1>Roulette</h1>

    <div class="roulette-wrapper">
        <canvas id="wheelCanvas" width="400" height="400"></canvas>
        <div id="ball" class="ball"></div>
    </div>

    <input type="number" id="bet" placeholder="Enter bet amount">

    <div class="choice-buttons">
        <button onclick="spin('red')">Red</button>
        <button onclick="spin('black')">Black</button>
        <button onclick="spin('green')">Green</button>
    </div>

    <p id="rouletteResult"></p>
</div>

<script>
// GLOBALS -----------------------------------------------------
let currentBalance = 0;
let wheelAngle = 0;
let spinning = false;
let winningNumber = null;

const redNumbers = [
  1,3,5,7,9,12,14,16,18,
  19,21,23,25,27,30,32,34,36
];

// BALANCE -----------------------------------------------------
async function loadBalance() {
    const username = localStorage.getItem("username");
    if (!username) return;

    const res = await fetch("http://localhost:3000/balance", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ username })
    });

    const data = await res.json();
    if (data.success) {
        currentBalance = data.balance;
        document.getElementById("balanceDisplay").innerText =
            "Balance: " + data.balance.toFixed(2);
    }
}

async function updateBalance(amount) {
    const username = localStorage.getItem("username");

    await fetch("http://localhost:3000/updateBalance", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ username, amount })
    });

    loadBalance();
}

// WHEEL DRAW --------------------------------------------------
const wheel = document.getElementById("wheelCanvas");
const ctx = wheel.getContext("2d");
const numSegments = 37;
const segmentAngle = (2 * Math.PI) / numSegments;

function drawWheel() {
    for (let i = 0; i < numSegments; i++) {
        const angleStart = wheelAngle + i * segmentAngle;
        const angleEnd = angleStart + segmentAngle;

        if (i === 0) ctx.fillStyle = "#00ff66"; // Green 0
        else if (redNumbers.includes(i)) ctx.fillStyle = "#ff3b3b";
        else ctx.fillStyle = "#111";

        ctx.beginPath();
        ctx.moveTo(200, 200);
        ctx.arc(200, 200, 190, angleStart, angleEnd);
        ctx.lineTo(200, 200);
        ctx.fill();

        // numbers
        ctx.fillStyle = "#fff";
        ctx.font = "16px Inter";
        ctx.save();
        ctx.translate(200, 200);
        ctx.rotate(angleStart + segmentAngle / 2);
        ctx.textAlign = "right";
        ctx.fillText(i, 160, 5);
        ctx.restore();
    }
}

// MAIN SPIN ---------------------------------------------------
function spin(choice) {
    if (spinning) return;

    const bet = Number(document.getElementById("bet").value);
    if (!bet || bet <= 0) return setOutput("Enter valid bet");
    if (bet > currentBalance) return setOutput("Not enough balance");

    updateBalance(-bet);

    spinning = true;

    winningNumber = Math.floor(Math.random() * 37);
    const spins = 10 + Math.random() * 3;
    const finalAngle = spins * 2 * Math.PI - winningNumber * segmentAngle;

    animateSpin(wheelAngle, finalAngle, 2000, () => {
        spinning = false;
        showResult(choice, bet);
    });
}

function animateSpin(start, end, duration, callback) {
    const startTime = performance.now();

    function frame(now) {
        const progress = Math.min((now - startTime) / duration, 1);
        const eased = easeOutCubic(progress);

        wheelAngle = start + (end - start) * eased;

        drawWheel();
        positionBall();

        if (progress < 1) requestAnimationFrame(frame);
        else callback();
    }
    requestAnimationFrame(frame);
}

function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
}

// BALL --------------------------------------------------------
const ball = document.getElementById("ball");

function positionBall() {
    const radius = 150;
    const angle = wheelAngle * 1.25; // creative offset

    const x = 200 + Math.cos(angle) * radius - 7;
    const y = 200 + Math.sin(angle) * radius - 7;

    ball.style.left = x + "px";
    ball.style.top = y + "px";
}

// RESULT ------------------------------------------------------
function showResult(choice, bet) {
    const result = document.getElementById("rouletteResult");

    let color = "green";
    if (winningNumber > 0 && winningNumber <= 18) color = "red";
    if (winningNumber >= 19 && winningNumber <= 36) color = "black";

    if (choice === color) {
        let payout = (color === "green") ? bet * 14 : bet * 2;
        updateBalance(payout);
        setOutput("You WON on " + color + " (" + winningNumber + ")");
    } else {
        setOutput("You lost. It was " + color + " (" + winningNumber + ")");
    }
}

// UI OUTPUT ---------------------------------------------------
function setOutput(text) {
    const box = document.getElementById("rouletteResult");
    box.innerText = text;
    box.style.opacity = 1;
    setTimeout(() => box.style.opacity = 0, 2500);
}

// INIT --------------------------------------------------------
drawWheel();
loadBalance();
</script>

<style>
.roulette-wrapper {
    position: relative;
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

#wheelCanvas {
    border-radius: 50%;
    box-shadow: 0 0 25px rgba(255,255,255,0.1);
}

.ball {
    position: absolute;
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    pointer-events: none;
    box-shadow: 0 0 8px white;
}
</style>

</body>
</html>
